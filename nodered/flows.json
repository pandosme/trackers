[{"id":"c67be6c.b53d618","type":"tab","label":"Tracker Settings","disabled":false,"info":""},{"id":"fbcc2ce6.a1932","type":"tab","label":"Tracker Agents","disabled":false,"info":""},{"id":"6a0f2e67.9f1bb","type":"tab","label":"Cameras","disabled":false,"info":""},{"id":"2be6d14.9dd5bae","type":"tab","label":"Device Discovery","disabled":false,"info":""},{"id":"c507b65f.83a0e8","type":"tab","label":"Test","disabled":false,"info":""},{"id":"ad1eff29.54fd18","type":"tab","label":"Camera Accounts","disabled":false,"info":""},{"id":"36a19762.352b1","type":"ui_group","z":"","name":"List","tab":"d00f885.4d85b78","disp":false,"width":"16","collapse":false},{"id":"ad7dae2.f228cd","type":"mongodb2","z":"","uri":"mongodb://mongo:27017/inventory","name":"Inventory","options":"","parallelism":"-1"},{"id":"a2c42f4.361655","type":"Camera Account","z":"","name":"trackers","protocol":"http"},{"id":"d00f885.4d85b78","type":"ui_tab","z":"","name":"Device Discovery","icon":"dashboard","disabled":false,"hidden":false},{"id":"daeeea9.63d9798","type":"mqtt-broker","z":"","name":"Local broker","broker":"broker","port":"1883","clientid":"","usetls":false,"compatmode":false,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"cd6756f4.1677a","type":"ui_base","theme":{"name":"theme-dark","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#097479","value":"#097479","edited":false},"page-titlebar-backgroundColor":{"value":"#097479","edited":false},"page-backgroundColor":{"value":"#111111","edited":false},"page-sidebar-backgroundColor":{"value":"#000000","edited":false},"group-textColor":{"value":"#0eb8c0","edited":false},"group-borderColor":{"value":"#555555","edited":false},"group-backgroundColor":{"value":"#333333","edited":false},"widget-textColor":{"value":"#eeeeee","edited":false},"widget-backgroundColor":{"value":"#097479","edited":false},"widget-borderColor":{"value":"#333333","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":50,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"26e044d6.da336c","type":"ui_spacer","name":"spacer","group":"36a19762.352b1","order":2,"width":"12","height":1},{"id":"fd17d3f8.e71e08","type":"ui_group","z":"","name":"Camera List","tab":"9a02fb67.7dcc08","disp":false,"width":"24","collapse":false},{"id":"9a02fb67.7dcc08","type":"ui_tab","z":"","name":"Cameras","icon":"dashboard","disabled":false,"hidden":false},{"id":"26a7dbce.52ef2c","type":"ui_tab","z":"","name":"Camera Administration","icon":"dashboard","disabled":false,"hidden":false},{"id":"b21feb30.24aac8","type":"ui_group","z":"","name":"Set trackers device account","tab":"26a7dbce.52ef2c","disp":true,"width":"6","collapse":false},{"id":"88584b9.75ee238","type":"ui_group","z":"","name":"Discovery Lost","tab":"d00f885.4d85b78","disp":false,"width":"16","collapse":false},{"id":"780ef417.a4426c","type":"ui_tab","z":"","name":"Tracker Agents","icon":"dashboard","disabled":false,"hidden":false},{"id":"2d2445e2.fb44d2","type":"ui_group","z":"","name":"ACAP Agents","tab":"780ef417.a4426c","disp":true,"width":"16","collapse":false},{"id":"675d52a1.bbb48c","type":"Camera Account","z":"","name":"root","protocol":"http"},{"id":"dc6427f8.e4c6d","type":"ui_group","z":"","name":"Image","tab":"39fb8fa6.9d6d58","order":1,"disp":true,"width":"18","collapse":false},{"id":"39fb8fa6.9d6d58","type":"ui_tab","z":"","name":"Tracker Settings","icon":"dashboard","order":2,"disabled":false,"hidden":false},{"id":"4ccecf16.2dc51","type":"ui_spacer","name":"spacer","group":"dc6427f8.e4c6d","order":4,"width":"8","height":1},{"id":"23cd3638.35a1da","type":"ui_button","z":"2be6d14.9dd5bae","name":"Refresh","group":"36a19762.352b1","order":1,"width":"4","height":"1","passthru":false,"label":"Refresh Table","tooltip":"","color":"","bgcolor":"","icon":"refresh","payload":"","payloadType":"str","topic":"","x":140,"y":200,"wires":[["432145b1.6c794c"]]},{"id":"bedbf0bb.96fb18","type":"ui_table","z":"2be6d14.9dd5bae","group":"36a19762.352b1","name":"","order":4,"width":"12","height":"9","columns":[{"field":"discoveryName","title":"UPnP/Bonjour","width":"","align":"left","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"mqtt","title":"MQTT ID","width":"","align":"left","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"address","title":"Address","width":"","align":"left","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"serial","title":"Serial","width":"","align":"left","formatter":"plaintext","formatterParams":{"target":"_blank"}}],"outputs":1,"cts":true,"x":530,"y":240,"wires":[["7095cb80.8e535c"]]},{"id":"c8f92171.46e1a","type":"function","z":"2be6d14.9dd5bae","name":"Camera","func":"msg.payload = {\n    serial: msg.payload.serial,\n    address: msg.payload.address,\n    discoveryName: msg.payload.name,\n    port: msg.payload.port\n}\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":140,"wires":[["f52a23c6.785ec"]]},{"id":"f52a23c6.785ec","type":"function","z":"2be6d14.9dd5bae","name":"Flow Discovey","func":"discovery = flow.get(\"discovery\")\nif( !discovery ) {\n    discovery = {}\n    flow.set(\"discovery\",discovery)\n}\ndiscovery[msg.payload.serial] = msg.payload\nreturn msg;\n","outputs":1,"noerr":0,"x":520,"y":100,"wires":[["ccbc8a3e.8eb38"]]},{"id":"ab46e522.d50c9","type":"function","z":"2be6d14.9dd5bae","name":"Camera","func":"if( msg.payload.connected === false )\n    return;\n    \nmsg.payload = {\n    serial: msg.payload.serial,\n    address: msg.payload.IPv4,\n    mqtt: msg.payload.client\n}\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":100,"wires":[["f52a23c6.785ec"]]},{"id":"6eecfeb2.e5cfa8","type":"mqtt in","z":"2be6d14.9dd5bae","name":"","topic":"connect/#","qos":"2","datatype":"json","broker":"daeeea9.63d9798","x":140,"y":100,"wires":[["ab46e522.d50c9"]]},{"id":"7095cb80.8e535c","type":"ui_form","z":"2be6d14.9dd5bae","name":"","label":"","group":"36a19762.352b1","order":3,"width":"4","height":"7","options":[{"label":"Name","value":"name","type":"text","required":true,"rows":null},{"label":"Serial","value":"serial","type":"text","required":true,"rows":null},{"label":"Address","value":"address","type":"text","required":true,"rows":null}],"formValue":{"name":"","serial":"","address":""},"payload":"","submit":"Deploy","cancel":"","topic":"","x":330,"y":300,"wires":[["6b332058.09307"]]},{"id":"6b332058.09307","type":"function","z":"2be6d14.9dd5bae","name":"Update","func":"var mqtt = \"\"\n\nvar discovery = flow.get(\"discovery\");\nnode.warn(discovery);\nif( discovery && discovery.hasOwnProperty(msg.payload.serial) && discovery[msg.payload.serial].hasOwnProperty(\"mqtt\"))\n    mqtt = discovery[msg.payload.serial].mqtt\n\nmsg.payload = [\n    { serial: msg.payload.serial },\n    {\n        '$set': {\n            name: msg.payload.name,\n            address: msg.payload.address,\n            serial: msg.payload.serial,\n            mqtt: mqtt\n        }\n    },\n    { upsert: true }\n];\nreturn msg;\n","outputs":1,"noerr":0,"x":500,"y":300,"wires":[["2256ca41.65539e"]]},{"id":"2256ca41.65539e","type":"mongodb2 in","z":"2be6d14.9dd5bae","service":"_ext_","configNode":"ad7dae2.f228cd","name":"","collection":"cameras","operation":"update","x":740,"y":300,"wires":[[]]},{"id":"5738e1f4.f8c81","type":"comment","z":"2be6d14.9dd5bae","name":"Refresh","info":"","x":750,"y":100,"wires":[]},{"id":"ccbc8a3e.8eb38","type":"link out","z":"2be6d14.9dd5bae","name":"","links":["f8ddeb2.0045298"],"x":675,"y":100,"wires":[]},{"id":"cac7d0b0.1490a8","type":"function","z":"2be6d14.9dd5bae","name":"Flow Discovey","func":"discovery = flow.get(\"discovery\")\nif( !discovery )\n    return;\nmsg.payload = [];\nfor( var key in discovery )\n    msg.payload.push(discovery[key]);\nreturn msg;\n","outputs":1,"noerr":0,"x":360,"y":240,"wires":[["bedbf0bb.96fb18"]]},{"id":"f8ddeb2.0045298","type":"link in","z":"2be6d14.9dd5bae","name":"Refresh Table","links":["432145b1.6c794c","ccbc8a3e.8eb38","f11ffe23.39ae78"],"x":235,"y":240,"wires":[["cac7d0b0.1490a8"]]},{"id":"b2c61ca6.a191f8","type":"comment","z":"2be6d14.9dd5bae","name":"Refresh Table","info":"","x":150,"y":240,"wires":[]},{"id":"432145b1.6c794c","type":"link out","z":"2be6d14.9dd5bae","name":"","links":["8b85db38.a12df","f8ddeb2.0045298"],"x":295,"y":200,"wires":[]},{"id":"97883062.3771e8","type":"ui_button","z":"6a0f2e67.9f1bb","name":"Refresh","group":"fd17d3f8.e71e08","order":1,"width":"1","height":"1","passthru":false,"label":"","tooltip":"","color":"","bgcolor":"","icon":"refresh","payload":"","payloadType":"str","topic":"","x":140,"y":440,"wires":[["b1f8382a.61e4b"]]},{"id":"3a258a95.1112a6","type":"function","z":"6a0f2e67.9f1bb","name":"Properties","func":"msg.payload = \"properties\"\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":500,"wires":[["f331c0b8.29025"]]},{"id":"f331c0b8.29025","type":"Axis Camera","z":"6a0f2e67.9f1bb","name":"","account":"a2c42f4.361655","address":"","action":"Get Properties","data":"","format":"default","x":580,"y":500,"wires":[["e2c913c6.2c7978","703f1040.9f525"]]},{"id":"703f1040.9f525","type":"debug","z":"6a0f2e67.9f1bb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":950,"y":500,"wires":[]},{"id":"e2c913c6.2c7978","type":"function","z":"6a0f2e67.9f1bb","name":"Parse","func":"if(msg.error){\n    node.warn(msg.payload)\n    return;\n}\n\nmsg.camera.platform = msg.payload.System.Architecture;\nmsg.camera.chip = msg.payload.System.Soc;\nmsg.camera.firmware = msg.payload.Firmware.Version;\n\nreturn msg;","outputs":1,"noerr":0,"x":770,"y":500,"wires":[["126ce845.7bb658"]]},{"id":"126ce845.7bb658","type":"function","z":"6a0f2e67.9f1bb","name":"Brand","func":"msg.payload = \"brand\"\nreturn msg;","outputs":1,"noerr":0,"x":310,"y":540,"wires":[["14149ba8.0b0a94"]]},{"id":"14149ba8.0b0a94","type":"Axis Camera","z":"6a0f2e67.9f1bb","name":"","account":"a2c42f4.361655","address":"","action":"Get Properties","data":"","format":"default","x":580,"y":540,"wires":[["c65db2d0.6a7fc8","2711ed9b.69428a"]]},{"id":"2711ed9b.69428a","type":"debug","z":"6a0f2e67.9f1bb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":950,"y":540,"wires":[]},{"id":"c65db2d0.6a7fc8","type":"function","z":"6a0f2e67.9f1bb","name":"Parse","func":"if(msg.error){\n    node.warn(msg.payload)\n    return;\n}\n\nmsg.camera.model = msg.payload.ProdNbr;\nmsg.camera.type = msg.payload.ProdType;\n\nreturn msg;","outputs":1,"noerr":0,"x":770,"y":540,"wires":[["5db1d8ff.f04668"]]},{"id":"5db1d8ff.f04668","type":"function","z":"6a0f2e67.9f1bb","name":"Network","func":"msg.payload = \"network\"\nreturn msg;","outputs":1,"noerr":0,"x":320,"y":580,"wires":[["978536.0da6cac8"]]},{"id":"978536.0da6cac8","type":"Axis Camera","z":"6a0f2e67.9f1bb","name":"","account":"a2c42f4.361655","address":"","action":"Get Properties","data":"","format":"default","x":580,"y":580,"wires":[["22f44b82.e195bc","bc738c0c.caa388"]]},{"id":"22f44b82.e195bc","type":"function","z":"6a0f2e67.9f1bb","name":"Parse","func":"if(msg.error){\n    node.warn(msg.payload)\n    return;\n}\n\nmsg.camera.mac = msg.payload.eth0.MACAddress\n//msg.camera.hostName = msg.payload.VolatileHostName.HostName\nmsg.camera.ipv4 = msg.payload.eth0.IPAddress\n\nreturn msg;","outputs":1,"noerr":0,"x":770,"y":580,"wires":[["58231109.061368"]]},{"id":"bc738c0c.caa388","type":"debug","z":"6a0f2e67.9f1bb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":950,"y":580,"wires":[]},{"id":"58231109.061368","type":"function","z":"6a0f2e67.9f1bb","name":"Sensor","func":"msg.payload = \"ImageSource.I0\"\nreturn msg;","outputs":1,"noerr":0,"x":320,"y":620,"wires":[["a3a21992.caedf8"]]},{"id":"a3a21992.caedf8","type":"Axis Camera","z":"6a0f2e67.9f1bb","name":"","account":"a2c42f4.361655","address":"","action":"Get Properties","data":"","format":"default","x":580,"y":620,"wires":[["bffac9dd.0bb488","d25e21ff.e4a96"]]},{"id":"bffac9dd.0bb488","type":"function","z":"6a0f2e67.9f1bb","name":"Parse","func":"if(msg.error){\n    node.warn(msg.payload)\n    return;\n}\n\nmsg.camera.capture = msg.payload.I0.CaptureFrequency\nmsg.camera.rotation = parseInt(msg.payload.I0.Rotation)\nmsg.camera.aspect = msg.payload.I0.Sensor.AspectRatio\n\nreturn msg;","outputs":1,"noerr":0,"x":770,"y":620,"wires":[["8449f35f.b610f8"]]},{"id":"d25e21ff.e4a96","type":"debug","z":"6a0f2e67.9f1bb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":950,"y":620,"wires":[]},{"id":"8449f35f.b610f8","type":"function","z":"6a0f2e67.9f1bb","name":"Update","func":"msg.payload = [\n    { serial: msg.camera.serial },\n    {\n        '$set': msg.camera\n    },\n    { upsert: true }\n];\nreturn msg;\n","outputs":1,"noerr":0,"x":320,"y":660,"wires":[["b18b1ea3.c46d38","a9957529.49b66"]]},{"id":"b18b1ea3.c46d38","type":"mongodb2 in","z":"6a0f2e67.9f1bb","service":"_ext_","configNode":"ad7dae2.f228cd","name":"","collection":"cameras","operation":"update","x":560,"y":660,"wires":[["5558be59.623ee8"]]},{"id":"5db24218.073e4c","type":"mongodb2 in","z":"6a0f2e67.9f1bb","service":"_ext_","configNode":"ad7dae2.f228cd","name":"","collection":"cameras","operation":"aggregate.toArray","x":390,"y":80,"wires":[["226c3aaa.4f590e"]]},{"id":"226c3aaa.4f590e","type":"ui_table","z":"6a0f2e67.9f1bb","group":"fd17d3f8.e71e08","name":"","order":8,"width":"17","height":"9","columns":[{"field":"name","title":"Name","width":"","align":"left","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"mqtt","title":"MQTT ID","width":"","align":"left","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"model","title":"Model","width":"","align":"left","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"address","title":"Address","width":"","align":"left","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"ipv4","title":"IP","width":"","align":"left","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"serial","title":"Serial","width":"","align":"left","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"firmware","title":"Firmware","width":"","align":"left","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"aspect","title":"Aspect","width":"","align":"left","formatter":"plaintext","formatterParams":{"target":"_blank"}}],"outputs":1,"cts":true,"x":630,"y":80,"wires":[["5db24218.073e4c","40afe5df.cdfa2c"]]},{"id":"fabbcdf5.9a1df8","type":"ui_form","z":"6a0f2e67.9f1bb","name":"Edit","label":"","group":"fd17d3f8.e71e08","order":9,"width":"5","height":"4","options":[{"label":"Name","value":"name","type":"text","required":false,"rows":null},{"label":"Address","value":"address","type":"text","required":false,"rows":null}],"formValue":{"name":"","address":""},"payload":"","submit":"Save","cancel":"","topic":"","x":450,"y":180,"wires":[["3618d9a8.b3627e"]]},{"id":"3618d9a8.b3627e","type":"function","z":"6a0f2e67.9f1bb","name":"Update","func":"camera = flow.get(\"camera\");\nif(!camera) return;\n\nmsg.payload = [\n    { serial: camera.serial },\n    {\n        '$set': msg.payload\n    },\n    { upsert: true }\n];\nreturn msg;\n","outputs":1,"noerr":0,"x":600,"y":180,"wires":[["3945c59d.0b39da"]]},{"id":"3945c59d.0b39da","type":"mongodb2 in","z":"6a0f2e67.9f1bb","service":"_ext_","configNode":"ad7dae2.f228cd","name":"","collection":"cameras","operation":"update","x":820,"y":180,"wires":[["507358b6.11bba8","e9022d9a.afa1c"]]},{"id":"40afe5df.cdfa2c","type":"function","z":"6a0f2e67.9f1bb","name":"Camera","func":"delete msg.payload._id\nflow.set(\"camera\",msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":780,"y":80,"wires":[["b1c5766e.b22838"]]},{"id":"3ba1f141.c18e66","type":"link in","z":"6a0f2e67.9f1bb","name":"Refresh Table","links":["507358b6.11bba8","950fccee.19223","5558be59.623ee8"],"x":175,"y":80,"wires":[["5db24218.073e4c"]]},{"id":"ec1510d9.237ed","type":"comment","z":"6a0f2e67.9f1bb","name":"Refresh","info":"","x":110,"y":80,"wires":[]},{"id":"507358b6.11bba8","type":"link out","z":"6a0f2e67.9f1bb","name":"","links":["3ba1f141.c18e66"],"x":995,"y":180,"wires":[]},{"id":"d76be41d.0e488","type":"comment","z":"6a0f2e67.9f1bb","name":"Refresh","info":"","x":1070,"y":180,"wires":[]},{"id":"e9fdae98.f7ebe","type":"function","z":"6a0f2e67.9f1bb","name":"Reset","func":"flow.set(\"camera\");\nmsg.payload = {\n    name: \"\",\n    address: \"\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":310,"y":220,"wires":[["fabbcdf5.9a1df8"]]},{"id":"eb8e395a.338e58","type":"link in","z":"6a0f2e67.9f1bb","name":"","links":["e9022d9a.afa1c","8e93d88d.601e38"],"x":215,"y":220,"wires":[["e9fdae98.f7ebe"]]},{"id":"82a817b5.6359f8","type":"comment","z":"6a0f2e67.9f1bb","name":"Reset","info":"","x":130,"y":220,"wires":[]},{"id":"e9022d9a.afa1c","type":"link out","z":"6a0f2e67.9f1bb","name":"","links":["eb8e395a.338e58"],"x":995,"y":220,"wires":[]},{"id":"883be62a.d36a48","type":"comment","z":"6a0f2e67.9f1bb","name":"Reset","info":"","x":1070,"y":220,"wires":[]},{"id":"b1c5766e.b22838","type":"link out","z":"6a0f2e67.9f1bb","name":"","links":["2a443b2e.092624"],"x":895,"y":80,"wires":[]},{"id":"a3894271.4746b","type":"comment","z":"6a0f2e67.9f1bb","name":"Edit","info":"","x":970,"y":80,"wires":[]},{"id":"2a443b2e.092624","type":"link in","z":"6a0f2e67.9f1bb","name":"Edit Camera","links":["b1c5766e.b22838"],"x":215,"y":180,"wires":[["fabbcdf5.9a1df8"]]},{"id":"b08678ee.f5d2c8","type":"comment","z":"6a0f2e67.9f1bb","name":"Edit","info":"","x":130,"y":180,"wires":[]},{"id":"cc69582e.d7bca8","type":"ui_button","z":"6a0f2e67.9f1bb","name":"","group":"fd17d3f8.e71e08","order":12,"width":"4","height":"1","passthru":false,"label":"Delete Camera","tooltip":"","color":"","bgcolor":"red","icon":"delete","payload":"","payloadType":"str","topic":"","x":160,"y":320,"wires":[["93adb630.f9a55"]]},{"id":"93adb630.f9a55","type":"function","z":"6a0f2e67.9f1bb","name":"Camera","func":"msg.camera = flow.get(\"camera\");\nif(!msg.camera) return;\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":320,"wires":[["c28661a2.9916a8"]]},{"id":"cf8dc02e.dc4f1","type":"ui_template","z":"6a0f2e67.9f1bb","group":"fd17d3f8.e71e08","name":"Operations","order":10,"width":"6","height":"1","format":"<h2>Operations</h2>","storeOutMessages":true,"fwdInMessages":true,"templateScope":"local","x":150,"y":260,"wires":[[]]},{"id":"c28661a2.9916a8","type":"function","z":"6a0f2e67.9f1bb","name":"Remove","func":"msg.payload = {\n    serial: msg.camera.serial\n}\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":320,"wires":[["89c1cf34.f6ce28"]]},{"id":"89c1cf34.f6ce28","type":"mongodb2 in","z":"6a0f2e67.9f1bb","service":"_ext_","configNode":"ad7dae2.f228cd","name":"","collection":"cameras","operation":"deleteOne","x":750,"y":320,"wires":[["950fccee.19223","8e93d88d.601e38"]]},{"id":"950fccee.19223","type":"link out","z":"6a0f2e67.9f1bb","name":"","links":["3ba1f141.c18e66"],"x":955,"y":320,"wires":[]},{"id":"a83913f9.70fe78","type":"comment","z":"6a0f2e67.9f1bb","name":"Refresh List","info":"","x":1050,"y":320,"wires":[]},{"id":"8e93d88d.601e38","type":"link out","z":"6a0f2e67.9f1bb","name":"","links":["eb8e395a.338e58"],"x":955,"y":360,"wires":[]},{"id":"f182841f.6503b8","type":"comment","z":"6a0f2e67.9f1bb","name":"Reset","info":"","x":1030,"y":360,"wires":[]},{"id":"6af280a3.05b8d8","type":"ui_form","z":"ad1eff29.54fd18","name":"","label":"","group":"b21feb30.24aac8","order":0,"width":0,"height":0,"options":[{"label":"Root account password","value":"root","type":"text","required":true,"rows":null},{"label":"Trackers password","value":"trackers","type":"text","required":false,"rows":null}],"formValue":{"root":"","trackers":""},"payload":"","submit":"submit","cancel":"cancel","topic":"","x":220,"y":100,"wires":[["85f2a4cb.ae4bb8"]]},{"id":"d55190b.a9877f","type":"Axis Camera","z":"ad1eff29.54fd18","name":"","account":"a2c42f4.361655","address":"","action":"Set Account","data":"","format":"default","x":630,"y":160,"wires":[["c2489714.db0258"]]},{"id":"85f2a4cb.ae4bb8","type":"function","z":"ad1eff29.54fd18","name":"User Input","func":"msg.userInput = msg.payload\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":100,"wires":[["1184ef30.a033f9"]]},{"id":"6d29b6b4.74fc1","type":"function","z":"ad1eff29.54fd18","name":"Account & Password","func":"msg.address = msg.payload.address\nmsg.user = \"root\";\nmsg.password = msg.userInput.root\nmsg.payload = {\n  user: \"trackers\",\n  password: msg.userInput.trackers,\n  privileges: \"Administrator\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":420,"y":160,"wires":[["d55190b.a9877f"]]},{"id":"1184ef30.a033f9","type":"mongodb2 in","z":"ad1eff29.54fd18","service":"_ext_","configNode":"ad7dae2.f228cd","name":"","collection":"cameras","operation":"aggregate.forEach","x":660,"y":100,"wires":[["6d29b6b4.74fc1"]]},{"id":"c2489714.db0258","type":"ui_toast","z":"ad1eff29.54fd18","position":"top right","displayTime":"3","highlight":"","sendall":false,"outputs":0,"ok":"OK","cancel":"","raw":true,"topic":"","name":"","x":830,"y":160,"wires":[]},{"id":"b1f8382a.61e4b","type":"mongodb2 in","z":"6a0f2e67.9f1bb","service":"_ext_","configNode":"ad7dae2.f228cd","name":"","collection":"cameras","operation":"aggregate.forEach","x":390,"y":440,"wires":[["4f3adad3.591b6c"]]},{"id":"dfcc6d6d.ef897","type":"debug","z":"6a0f2e67.9f1bb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":930,"y":440,"wires":[]},{"id":"4f3adad3.591b6c","type":"function","z":"6a0f2e67.9f1bb","name":"Camera","func":"msg.camera = msg.payload;\ndelete msg.camera._id;\nmsg.address = msg.camera.address\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":440,"wires":[["dfcc6d6d.ef897","3a258a95.1112a6"]]},{"id":"5558be59.623ee8","type":"link out","z":"6a0f2e67.9f1bb","name":"","links":["3ba1f141.c18e66"],"x":735,"y":660,"wires":[]},{"id":"62c79be6.667be4","type":"comment","z":"6a0f2e67.9f1bb","name":"Refresh","info":"","x":810,"y":660,"wires":[]},{"id":"a9957529.49b66","type":"debug","z":"6a0f2e67.9f1bb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"camera","targetType":"msg","x":950,"y":660,"wires":[]},{"id":"43f0b8d3.4f2a68","type":"ui_button","z":"fbcc2ce6.a1932","name":"Refresh","group":"2d2445e2.fb44d2","order":1,"width":"1","height":"1","passthru":false,"label":"","tooltip":"","color":"","bgcolor":"","icon":"refresh","payload":"","payloadType":"str","topic":"","x":120,"y":100,"wires":[["4387f020.6fabd8"]]},{"id":"8b2287d5.551ca","type":"mongodb2 in","z":"fbcc2ce6.a1932","service":"_ext_","configNode":"ad7dae2.f228cd","name":"","collection":"cameras","operation":"aggregate.forEach","x":530,"y":100,"wires":[["c1c13f69.55a64"]]},{"id":"c1c13f69.55a64","type":"function","z":"fbcc2ce6.a1932","name":"Camera","func":"msg.camera = msg.payload;\ndelete msg.camera._id;\nmsg.address = msg.camera.address\nreturn msg;","outputs":1,"noerr":0,"x":760,"y":100,"wires":[["a24d28da.76352"]]},{"id":"a24d28da.76352","type":"Axis Camera","z":"fbcc2ce6.a1932","name":"","account":"675d52a1.bbb48c","address":"","action":"List ACAP","data":"","format":"default","x":440,"y":160,"wires":[["63b35ec5.1ced18"]]},{"id":"63b35ec5.1ced18","type":"function","z":"fbcc2ce6.a1932","name":"Parse","func":"if( msg.error) {\n    node.warn(\"Cannot read ACAPs\")\n    return;\n}\n\nmsg.camera.agent = null;\nmsg.payload.forEach(function(acap){\n    if(acap.Name === \"tracker\") {\n        msg.camera.agent = {\n            version: acap.Version,\n            status: acap.Status,\n            connected: false\n        }\n    }\n    \n})\n\nagents = flow.get(\"agents\");\nif( !agents ) {\n    agents = [];\n    flow.set(\"agents\",agents)\n}\nagents.push(msg.camera);\nmsg.payload = agents;\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":160,"wires":[["c3ce64ab.ac6328"]]},{"id":"c3ce64ab.ac6328","type":"ui_table","z":"fbcc2ce6.a1932","group":"2d2445e2.fb44d2","name":"","order":4,"width":"16","height":"8","columns":[{"field":"name","title":"Camera","width":"","align":"left","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"agent.version","title":"Version","width":"","align":"left","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"agent.status","title":"Status","width":"","align":"left","formatter":"plaintext","formatterParams":{"target":"_blank"}}],"outputs":0,"cts":false,"x":750,"y":160,"wires":[]},{"id":"4387f020.6fabd8","type":"function","z":"fbcc2ce6.a1932","name":"Reset","func":"msg.payload = []\nflow.set(\"agents\",[]);\nreturn msg;","outputs":1,"noerr":0,"x":310,"y":100,"wires":[["8b2287d5.551ca"]]},{"id":"35f74c76.a510ac","type":"ui_button","z":"fbcc2ce6.a1932","name":"","group":"2d2445e2.fb44d2","order":4,"width":"4","height":"1","passthru":false,"label":"Start","tooltip":"","color":"","bgcolor":"green","icon":"","payload":"","payloadType":"str","topic":"","x":130,"y":280,"wires":[["91ec9678.8c02b"]]},{"id":"88352fc5.6df89","type":"ui_button","z":"fbcc2ce6.a1932","name":"","group":"2d2445e2.fb44d2","order":4,"width":"4","height":"1","passthru":false,"label":"Stop","tooltip":"","color":"","bgcolor":"red","icon":"","payload":"","payloadType":"str","topic":"","x":130,"y":340,"wires":[["fdd74b19.f61998"]]},{"id":"9e4bef3e.1b2548","type":"ui_button","z":"fbcc2ce6.a1932","name":"","group":"2d2445e2.fb44d2","order":4,"width":"4","height":"1","passthru":false,"label":"Install / Update","tooltip":"","color":"","bgcolor":"blue","icon":"","payload":"","payloadType":"str","topic":"","x":160,"y":420,"wires":[["3a0098fa.52eca"]]},{"id":"91ec9678.8c02b","type":"mongodb2 in","z":"fbcc2ce6.a1932","service":"_ext_","configNode":"ad7dae2.f228cd","name":"","collection":"cameras","operation":"aggregate.forEach","x":370,"y":280,"wires":[["66dd3532.9e1384"]]},{"id":"66dd3532.9e1384","type":"function","z":"fbcc2ce6.a1932","name":"Address & Tracker","func":"msg.address = msg.payload.address\nmsg.payload = \"tracker\"\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":280,"wires":[["51d7af21.53325"]]},{"id":"51d7af21.53325","type":"Axis Camera","z":"fbcc2ce6.a1932","name":"","account":"675d52a1.bbb48c","address":"","action":"Start ACAP","data":"","format":"default","x":850,"y":280,"wires":[["342f77d0.8d22d"]]},{"id":"fdd74b19.f61998","type":"mongodb2 in","z":"fbcc2ce6.a1932","service":"_ext_","configNode":"ad7dae2.f228cd","name":"","collection":"cameras","operation":"aggregate.forEach","x":370,"y":340,"wires":[["d8ca7e35.6becc"]]},{"id":"d8ca7e35.6becc","type":"function","z":"fbcc2ce6.a1932","name":"Address & Tracker","func":"msg.address = msg.payload.address\nmsg.payload = \"tracker\"\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":340,"wires":[["867fdb9c.03341"]]},{"id":"867fdb9c.03341","type":"Axis Camera","z":"fbcc2ce6.a1932","name":"","account":"675d52a1.bbb48c","address":"","action":"Stop ACAP","data":"","format":"default","x":850,"y":340,"wires":[["342f77d0.8d22d"]]},{"id":"342f77d0.8d22d","type":"trigger","z":"fbcc2ce6.a1932","op1":"","op2":"true","op1type":"nul","op2type":"bool","duration":"3","extend":true,"units":"s","reset":"","bytopic":"all","name":"","x":1020,"y":280,"wires":[["92fc11b2.f7d2","5bf83338.0dfc24"]]},{"id":"92fc11b2.f7d2","type":"link out","z":"fbcc2ce6.a1932","name":"","links":["964a1174.3ffac8"],"x":1175,"y":280,"wires":[]},{"id":"4c627053.eb7ea8","type":"comment","z":"fbcc2ce6.a1932","name":"","info":"","x":120,"y":160,"wires":[]},{"id":"964a1174.3ffac8","type":"link in","z":"fbcc2ce6.a1932","name":"","links":["92fc11b2.f7d2"],"x":215,"y":160,"wires":[["4387f020.6fabd8"]]},{"id":"5bf83338.0dfc24","type":"debug","z":"fbcc2ce6.a1932","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1200,"y":340,"wires":[]},{"id":"3a0098fa.52eca","type":"function","z":"fbcc2ce6.a1932","name":"Message","func":"msg.payload = \"Update not yet implemented\"\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":420,"wires":[["51f36e87.06d778"]]},{"id":"51f36e87.06d778","type":"ui_toast","z":"fbcc2ce6.a1932","position":"top right","displayTime":"3","highlight":"red","sendall":true,"outputs":0,"ok":"OK","cancel":"","raw":false,"topic":"","name":"","x":550,"y":420,"wires":[]},{"id":"c44e6201.a9cb58","type":"ui_dropdown","z":"c67be6c.b53d618","name":"Device Select","label":"","tooltip":"","place":"Select Camera...","group":"dc6427f8.e4c6d","order":2,"width":"4","height":"1","passthru":false,"options":[],"payload":"","topic":"","x":840,"y":140,"wires":[["142205da.f0815a"]]},{"id":"d77dd160.8ad5b","type":"mongodb2 in","z":"c67be6c.b53d618","service":"_ext_","configNode":"ad7dae2.f228cd","name":"","collection":"cameras","operation":"aggregate.toArray","x":430,"y":140,"wires":[["13c507b3.8b18c8"]]},{"id":"13c507b3.8b18c8","type":"function","z":"c67be6c.b53d618","name":"Options","func":"msg.options = [];\nmsg.payload.forEach(function(item){\n    option = {}\n    option[item.name] = item\n    msg.options.push(option);\n})\nmsg.payload = \"\"\nreturn msg;","outputs":1,"noerr":0,"x":680,"y":140,"wires":[["c44e6201.a9cb58"]]},{"id":"f7615136.f76ee","type":"link in","z":"c67be6c.b53d618","name":"Reset Camera List","links":["462e3b3f.54e6e4","50c52b45.1759ec","a5e4396d.c0d678"],"x":235,"y":140,"wires":[["d77dd160.8ad5b"]]},{"id":"9cbae95f.47cf","type":"comment","z":"c67be6c.b53d618","name":"Reset Cameras","info":"","x":120,"y":140,"wires":[]},{"id":"49789f8f.cb7df","type":"link out","z":"c67be6c.b53d618","name":"Camera Selected","links":["8ac2621a.7b741","db80723.7a25b1"],"x":1155,"y":140,"wires":[]},{"id":"bdd3f26c.8b3868","type":"Axis Camera","z":"c67be6c.b53d618","name":"","account":"a2c42f4.361655","address":"","action":"Image","data":"","format":"base64","x":490,"y":220,"wires":[["7f34138d.a066b4"]]},{"id":"7f34138d.a066b4","type":"ui_template","z":"c67be6c.b53d618","group":"dc6427f8.e4c6d","name":"Image","order":5,"width":"13","height":"7","format":"<div id=\"{{'view_'+$id}}\" style=\"width:640px; height:360px\">\n    <div id=\"{{'frame_'+$id}}\" style=\"width:100%; height:100%; position:relative\">\n        <img id=\"{{'image_'+$id}}\" class=\"card-img-top\" src=\"\" style=\"width:100%; height:100%; position:absolute; top:0px; left:0px;\">\n        <canvas id=\"{{'canvas_'+$id}}\" width=\"1000\" height=\"1000\" style=\"width:100%; height:100%; position:absolute; top:0px; left:0px;\"></canvas>\n    </div>\n</div>\n\n<script>\nvar tracker_settings_context = null;\nvar tracker_settings_image = null;\n(function(scope) {\n    scope.$watch('msg', function(msg) {\n        if (!msg || msg.topic !== \"image\" )\n            return;\n        console.log(\"Image\");\n        var canvas = document.getElementById(\"canvas_\"+scope.$id);\n        if( canvas )\n            tracker_settings_context = canvas.getContext(\"2d\");\n        tracker_settings_image = $(\"#image_\"+scope.$id);\n        $(\"#image_\"+scope.$id).attr(\"src\", 'data:image/jpeg;base64, ' + msg.payload);\n    });\n})(scope);\n</script>","storeOutMessages":true,"fwdInMessages":true,"templateScope":"local","x":670,"y":220,"wires":[[]]},{"id":"3fd5869e.b727da","type":"mqtt in","z":"c67be6c.b53d618","name":"","topic":"tracker/#","qos":"2","datatype":"json","broker":"daeeea9.63d9798","x":100,"y":300,"wires":[["f9f4f6f9.ed491"]]},{"id":"7b299ba3.5319f4","type":"ui_template","z":"c67be6c.b53d618","group":"dc6427f8.e4c6d","name":"Context","order":6,"width":"1","height":"1","format":"<script>\nvar ctx = null;\nvar canvas = null;\n(function(scope) {\n    scope.$watch('msg', function(msg) {\n        if (!msg)\n            return;\n        if( msg.topic.split(\"/\")[0] !== \"tracker\" )\n            return;\n        if(!tracker_settings_context)\n            return;\n        var object = msg.payload;\n        tracker_settings_context.lineWidth = 3;\n        tracker_settings_context.strokeStyle = '#00FF00';\n        tracker_settings_context.beginPath();\n        tracker_settings_context.rect( object.x, object.y, object.w, object.h );\n        tracker_settings_context.stroke();\n    });\n})(scope);\n</script>","storeOutMessages":false,"fwdInMessages":false,"templateScope":"local","x":440,"y":300,"wires":[[]]},{"id":"8848c08e.6d6388","type":"function","z":"c67be6c.b53d618","name":"Address","func":"msg.topic = \"image\";\nmsg.camera = msg.payload\nmsg.address = msg.payload.address\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":220,"wires":[["bdd3f26c.8b3868"]]},{"id":"8ac2621a.7b741","type":"link in","z":"c67be6c.b53d618","name":"Image","links":["49789f8f.cb7df"],"x":235,"y":220,"wires":[["8848c08e.6d6388"]]},{"id":"8f4bddcc.5453b","type":"comment","z":"c67be6c.b53d618","name":"Reset Cameras","info":"","x":120,"y":220,"wires":[]},{"id":"142205da.f0815a","type":"function","z":"c67be6c.b53d618","name":"Flow Camera","func":"flow.set(\"camera\",msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":140,"wires":[["49789f8f.cb7df"]]},{"id":"f9f4f6f9.ed491","type":"function","z":"c67be6c.b53d618","name":"Filter","func":"camera = flow.get(\"camera\");\nif(!camera)\n    return;\nif( msg.topic.split(\"/\")[1] !== camera.mqtt )\n    return;\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":300,"wires":[["7b299ba3.5319f4"]]},{"id":"84b0fde6.7ddcb","type":"ui_button","z":"c67be6c.b53d618","name":"","group":"dc6427f8.e4c6d","order":1,"width":"3","height":"1","passthru":false,"label":"Reset","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"","x":90,"y":380,"wires":[["fccd8e57.ac4558"]]},{"id":"fccd8e57.ac4558","type":"function","z":"c67be6c.b53d618","name":"Reset","func":"msg.topic = \"reset\";\nflow.set(\"camera\");\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":380,"wires":[["89d3fdf2.a40e28"]]},{"id":"89d3fdf2.a40e28","type":"ui_template","z":"c67be6c.b53d618","group":"dc6427f8.e4c6d","name":"Context","order":7,"width":"1","height":"1","format":"<script>\n(function(scope) {\n    scope.$watch('msg', function(msg) {\n        if (!msg || msg.topic !== \"reset\" | !tracker_settings_image | !tracker_settings_context)\n            return;\n        tracker_settings_image.attr(\"src\",\"\");\n        tracker_settings_context.beginPath();\n        tracker_settings_context.clearRect(0, 0, 1000, 1000 );\n        tracker_settings_context.stroke();        \n    });\n})(scope);\n</script>","storeOutMessages":false,"fwdInMessages":true,"templateScope":"local","x":440,"y":380,"wires":[["50c52b45.1759ec"]]},{"id":"50c52b45.1759ec","type":"link out","z":"c67be6c.b53d618","name":"","links":["f7615136.f76ee"],"x":535,"y":380,"wires":[]},{"id":"4f4cabd5.c872d4","type":"ui_button","z":"c67be6c.b53d618","name":"","group":"dc6427f8.e4c6d","order":3,"width":"3","height":"1","passthru":false,"label":"Flush","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"flush","x":90,"y":440,"wires":[["d937491e.8f6f38"]]},{"id":"d937491e.8f6f38","type":"ui_template","z":"c67be6c.b53d618","group":"dc6427f8.e4c6d","name":"Context","order":8,"width":"1","height":"1","format":"<script>\n(function(scope) {\n    scope.$watch('msg', function(msg) {\n        if (!msg || msg.topic !== \"flush\" | !tracker_settings_context )\n            return;\n        tracker_settings_context.beginPath();\n        tracker_settings_context.clearRect(0, 0, 1000, 1000 );\n        tracker_settings_context.stroke();        \n    });\n})(scope);\n</script>","storeOutMessages":false,"fwdInMessages":true,"templateScope":"local","x":280,"y":440,"wires":[[]]},{"id":"db80723.7a25b1","type":"link in","z":"c67be6c.b53d618","name":"","links":["49789f8f.cb7df"],"x":235,"y":520,"wires":[["e2195fe8.b2b55"]]},{"id":"c9adbb80.a3bde8","type":"comment","z":"c67be6c.b53d618","name":"Edit","info":"","x":90,"y":520,"wires":[]},{"id":"e2195fe8.b2b55","type":"function","z":"c67be6c.b53d618","name":"Address","func":"msg.address = msg.payload.address\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":520,"wires":[["896ccbdb.130a58"]]},{"id":"896ccbdb.130a58","type":"Axis Camera","z":"c67be6c.b53d618","name":"","account":"675d52a1.bbb48c","address":"","action":"HTTP GET","data":"/local/tracker/settings","format":"json","x":520,"y":520,"wires":[["9863dd8b.1da548","a4375d88.a48fe8","61e0c8e9.240e88"]]},{"id":"9863dd8b.1da548","type":"function","z":"c67be6c.b53d618","name":"Error","func":"if(msg.error)\n    return msg;","outputs":1,"noerr":0,"x":690,"y":520,"wires":[["d886de58.9569d8"]]},{"id":"a4375d88.a48fe8","type":"function","z":"c67be6c.b53d618","name":"Ok","func":"if(msg.error)\n    return;\ntracker = msg.payload.tracker;\nflow.set(\"tracker\",tracker)\nmsg.payload = {\n    sway: tracker.sway / 10,\n    age: tracker.age / 1000,\n    speed: tracker.speed\n}\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":580,"wires":[["14571e88.564761","1c024ebd.714cd1"]]},{"id":"d886de58.9569d8","type":"debug","z":"c67be6c.b53d618","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":850,"y":520,"wires":[]},{"id":"14571e88.564761","type":"ui_form","z":"c67be6c.b53d618","name":"","label":"","group":"dc6427f8.e4c6d","order":8,"width":"5","height":"6","options":[{"label":"Min. sway (%)","value":"sway","type":"number","required":true,"rows":null},{"label":"Min. age (s)","value":"age","type":"number","required":true,"rows":null}],"formValue":{"sway":"","age":""},"payload":"","submit":"submit","cancel":"cancel","topic":"","x":490,"y":580,"wires":[[]]},{"id":"1c024ebd.714cd1","type":"debug","z":"c67be6c.b53d618","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":500,"y":620,"wires":[]},{"id":"61e0c8e9.240e88","type":"debug","z":"c67be6c.b53d618","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":710,"y":560,"wires":[]}]